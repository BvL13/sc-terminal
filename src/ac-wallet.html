<link rel="import" href="../bower_components/polymer/polymer.html">
<script src="../bower_components/web3/dist/web3.min.js"></script>
<script src="../bower_components/hooked-web3-provider/build/hooked-web3-provider.min.js"></script>

<link rel="import" href="ac-helpers.html">
<link rel="import" href="ac-config.html">
<link rel="import" href="ac-balance.html">
<link rel="import" href="ac-web3.html">

<dom-module id="ac-wallet">

  <template>
    <ac-config web3host="{{host}}" config="{{config}}" tokencontractaddress="{{tokencontractaddress}}"></ac-config>  
    <ac-helpers id="helpers"></ac-helpers>
  </template>

  <script>
    Polymer({

      is: 'ac-wallet',

      properties: {
        ethbalance: {
          type: Number,
          notify: true,
          value: 0
        },
        web3: {
          type: Object,
          notify: true,
          observer: '_web3'
        },
        arcbalance: {
          type: Number,
          notify: true,
          value: 0
        },
        pubkey: {
          type: String,
          observer: '_pubkey'
        },
        updating: {
          type: Boolean,
          value: false,
          notify: true
        },
      },

      attached: function() {
        console.log('ac-wallet attached');
        //this.updateBalance();
      },

      _web3: function(){
         this.updateBalance();
      },

      _pubkey: function(){
         this.updateBalance();
      },

      monitorBalance: function(){
        if (!this.monitorcount || this.monitorcount == 0){
          this.monitorcount = 6;
          this.monitorInterval = setInterval(this.updateBalanceIntervalHandler.bind(this), 5000);          
        }
        this.updateBalanceIntervalHandler();
      },

      updateBalanceIntervalHandler: function(){
        this.updateBalance();
        this.monitorcount--;
        console.log('monitorcount',this.monitorcount)
        if (this.monitorcount < 1){
            clearInterval(this.monitorInterval);
            console.log('clearing interval');
        }
      },

      updateBalance: function(e) {
        var self = this;

        if (!this.pubkey || !self.web3 || !self.web3.eth) {
          return;
        }

        if (!this.ARCTokeninstance) {
          this.$.helpers.getjson('./contracts/ARCToken.json', function(err, tokendata) {
            var contract = self.web3.eth.contract(tokendata.abi);
            self.ARCTokeninstance = contract.at(self.config.tokencontractaddress);
            self._readARCBalance();
          });
        }else{
            self._readARCBalance();
        }
        if (!this.SWTTokeninstance) {
          this.$.helpers.getjson('./contracts/MiniMeToken.json', function(err, tokendata) {
            var contract = self.web3.eth.contract(tokendata.abi);
            self.SWTTokeninstance = contract.at(self.config.swttokencontractaddress);
            self._readSWTBalance();
          });
        }else{
            self._readSWTBalance();
        }        
      },

      _readARCBalance: function() {
        if (!this.ARCTokeninstance || !this.pubkey) {
          return;
        }
        var self = this;
        this.debounce('_readARCBalance', function() {
          self.updating = true;
          self.ethbalance = self.web3.eth.getBalance(self.$.helpers.fixaddress(self.pubkey)).toNumber();
          self.arcbalance = self.ARCTokeninstance.balanceOf(self.$.helpers.fixaddress(self.pubkey)).toNumber();
          self.updating = false;
          if (self.arcbalance > 0) {
            self.fire('hasarcbalance');
          }
          console.log('ETH balance is', self.ethbalance);
          console.log('ARC balance is', self.arcbalance);
        }, 500);

      },

      _readSWTBalance: function() {
        if (!this.SWTTokeninstance || !this.pubkey) {
          return;
        }
        var self = this;
        this.debounce('_readSWTBalance', function() {
          this.updating = true;
          self.swtbalance = self.SWTTokeninstance.balanceOf(self.$.helpers.fixaddress(self.pubkey)).toNumber();
          self.updating = false;

          console.log('SWT balance is', this.swtbalance);
        }, 500);
      }

    });
  </script>
</dom-module>
