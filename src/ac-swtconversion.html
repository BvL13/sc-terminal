<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<!-- <link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/ac-input/ac-input.html">
<link rel="import" href="../bower_components/ac-button/ac-button.html">
<link rel="import" href="../bower_components/ac-style/ac-style.html"> -->

<link rel="import" href="../bower_components/sc-style/sc-style.html">
<link rel="import" href="../bower_components/sc-iconset/sc-iconset.html">

<link rel="import" href="sc-loader.html">

<link rel="import" href="ac-helpers.html">
<link rel="import" href="ac-password.html">
<link rel="import" href="ac-statusitem.html">
<link rel="import" href="ac-spinner.html">
<link rel="import" href="ac-wallet.html">
<link rel="import" href="ac-config.html">
<link rel="import" href="../bower_components/neon-animation/neon-animation.html">

<dom-module id="ac-swtconversion">
<link rel="import" href="../bower_components/sc-style/sc-style.css" type="css">

<style>
:host {
  display: block;
  width: 100%;
  height: 100%;
}

/*  .total {
    height: 100%;
  }*/

  neon-animated-pages {
    height: 92%;
  }

  .bigp {
    font-size: 20px;
    line-height: 22px;
  }

  .bigh {
     font-size: 62px;
    line-height: 68px;   
  }

  .blueborder {
    border: 2px dotted rgba(36,177,255,0.5);
    box-sizing:border-box;
    padding: 20px 25px 20px 30px;
  }


  .item {
   /* max-width: 730px;*/
    margin: 0px;
  }

  .steptime {
    font-size: 14px;
    line-height: 15px;    
  }

  .stepnr {
    width: 20px;
  }

  .lightgrey {
    color: rgba(0,0,0,0.10);

  }
  .maxwidth {
    max-width: 530px;
  }

  .stateicon {
    width: 40px;
    min-width: 40px;
    height: 40px;
    min-height: 40px;
  }


  @media all and (min-width: 0) and (max-width: 620px) { 
  .item {
    margin: 2vh 0px 2vh 0px;
  }
  }

</style>
<template>

  <ac-config tokencontractaddress="{{ARCTokenAddress}}"></ac-config>
  <ac-helpers id="helpers"></ac-helpers>
  <app-route route="{{route}}" pattern="/:page" data="{{data}}"></app-route>


    <div class="topbar basestructure">
      <span class="flex"></span>
      <iron-icon class="grey3" icon="sc-icons:decline" on-tap="exit">back</iron-icon>
    </div>

  <neon-animated-pages attr-for-selected="data-page" selected="[[data.page]]" entry-animation="{{entryAnimation}}" exit-animation="{{exitAnimation}}">

    <neon-animatable data-page="start">

      <div class="total vertic start paddingsides basestructure">
          <div class="whitespace"></div>
          <div class="whitespace"></div>

          <div class="blueborder">
            <p class="bold blue">Your ARC-balance</p>
            <h1 class="bold blue bigh">{{arcbalance}}</h1>
          </div>

          <div class="whitespace"></div>
          <div class="whitespace"></div>

          <div class=""> 
            <p class="grey4"><span class="reg">You will receive <span class="">{{arcbalance}} SWT</span> (conversion rate 1:1).</span><br>Converting the tokens might take a couple of minutes, don't close your browser.</p>
          </div>

          <div class="whitespace"></div>
          <div class="whitespace"></div>
          <div class="totalwidth vertic">
            <div class="totalwidth horizont centercenter item">
              <template is="dom-if" if="{{_is(firststate,'init')}}">
                <div class="flex">
                  <p class="bold lightgrey">Allowing the SWT-contract to receive your ARC</p>
                </div>
                <div class="stateicon">
                  <iron-icon icon="sc-icons:v" class="lightgrey big"></iron-icon>
                </div>
              </template>
              <template is="dom-if" if="{{_is(firststate,'doing')}}">
                <div class="flex" on-tap="succestest">
                  <p class="bold">Allowing the SWT-contract to receive your ARC</p>
                </div>
                <div class="stateicon">
                  <sc-loader color="blue"></sc-loader>
                </div>
              </template>
              <template is="dom-if" if="{{_is(firststate,'succes')}}">
                <div class="flex">
                  <p class="bold green">Allowed the SWT-contract to receive your ARC</p>
                </div>
                <div class="stateicon">
                  <iron-icon icon="sc-icons:v" class="green big"></iron-icon>
                </div>
              </template>
              <template is="dom-if" if="{{_is(firststate,'error')}}">
                <div class="flex">
                  <p class="bold red">Something went wrong. {{errormsg}}</p>
                </div>
                <div class="stateicon">
                  <iron-icon icon="sc-icons:decline" class="red big"></iron-icon>
                </div>
              </template>
            </div>

            <div class="totalwidth horizont centercenter item">
              <template is="dom-if" if="{{_is(secondstate,'init')}}">
                <div class="flex">
                  <p class="bold lightgrey">Issueing your new SWT and sending them to you</p>
                </div>
                <div class="stateicon">
                  <iron-icon icon="sc-icons:v" class="lightgrey big"></iron-icon>
                </div>
              </template>
              <template is="dom-if" if="{{_is(secondstate,'doing')}}">
                <div class="flex" on-tap="errortest">
                  <p class="bold">Issueing your new SWT and sending them to you</p>
                </div>
                <div class="stateicon">
                  <sc-loader color="blue"></sc-loader>
                </div>
              </template>
              <template is="dom-if" if="{{_is(secondstate,'succes')}}">
                <div class="flex">
                  <p class="bold green">Issued your new SWT and sended them to you</p>
                </div>
                <div class="stateicon">
                  <iron-icon icon="sc-icons:v" class="green big"></iron-icon>
                </div>
              </template>
              <template is="dom-if" if="{{_is(secondstate,'error')}}">
                <div class="flex">
                  <p class="bold red">Something went wrong. {{errormsg}}</p>
                </div>
                <div class="stateicon">
                  <iron-icon icon="sc-icons:decline" class="red big"></iron-icon>
                </div>
              </template>
            </div>

          </div>

          <div class="whitespace"></div>
          <div class="whitespace"></div>

          <div class="vertic yesnobtns">
            <paper-button class="blueback white shadow yesno bigbtn centertxt" on-tap="startconvert" noink disabled="{{convertingstarted}}">convert my ARC to SWT</paper-button>
          </div>
          <div class="whitespace"></div>

          <!-- <div class="totalwidth horizont startjust start">
            <p class="stepnr grey4 bold">1.</p>
            <div class="vertical totalwidth start startjust">
              <p class="grey4 bold">Give allowance <span class="steptime">(est. time 1 min)</class>
              <template is="dom-if" if="{{giveallowanceshow}}">
                <span id="giveallowance" on-tap="collapseMe" class="blue">details</span>
              </template></p>
               <iron-collapse class="collapserz vertic start" id="giveallowancecollapser">
                <p>details bee here</p>
               </iron-collapse>
            </div>
          </div>

          <div class="whitespace"></div>

          <div class="totalwidth horizont startjust start">
            <p class="stepnr grey4 bold">2.</p>
            <div class="vertical totalwidth start startjust">
              <p class="grey4 bold">Convert tokens <span class="steptime">(est. time 1 min) â€¢ </class>
              <template is="dom-if" if="{{converttokensshow}}">
                <span id="converttokens" on-tap="collapseMe" class="blue">details</span>
              </template>
              </p>
               <iron-collapse class="collapserz vertic start" id="converttokenscollapser">
                <p>details bee here</p>
               </iron-collapse>
            </div>
          </div>
          <div class="whitespace"></div>
          <div class="whitespace"></div> -->
        </div>
    </neon-animatable>

    <neon-animatable data-page="confirm">
      <!-- <div class="total vertic">
      <h2 class="red">ARC to SWT process</h2>
      <div class="whitespace"></div>

      <ol class="white">
        <li><ac-statusitem id="s1" status="inactive">Asking permission to transfer ARC</ac-statusitem></li>
        <li><ac-statusitem id="s2" status="inactive">Permission to transfer ARC granted</ac-statusitem></li>
        <li><ac-statusitem id="s3" status="inactive">Sending ARC to SWT contract</ac-statusitem></li>
        <li><ac-statusitem id="s4" status="inactive">SWT received</ac-statusitem></li>
      </ol>

      <div class="whitespace"></div>
      <div class="whitespace"></div>
      <div class="yesnobtns vertic">
        <ac-button big id="startbtn" class="yesno" bg="btncolor" txtcolor="red" on-tap="startconversion" txtbtn>Start</ac-button>
        <ac-spinner hidden id="processspinner" big>spinning</ac-spinner>
        <ac-button big hidden id="continuebtn" class="yesno" bg="btncolor" txtcolor="red" on-tap="startconversion" txtbtn>All set.</ac-button>
      </div>
    </div> -->
    </neon-animatable>


  </neon-animated-pages>
</template>

<script>
Polymer({

  is: 'ac-swtconversion',

  properties: {
    route: {
      type: Object,
      notify: true,
    },
    web3: {
      type: Object,
    },
    arcbalance: {
      type: Number,
      value: '3000.0'
    }
  },

  attached: function(){
    console.log('ac-swtconversion attached');
    this.exitAnimation = "slide-left-animation";
    this.entryAnimation = "slide-from-right-animation";
    // this.giveallowanceshow = true;
    // this.converttokensshow = true;
      this.convertingstarted = false;
      this.firststate = 'init';
      this.secondstate = 'init';

      this.errormsg = "NOBODY PANIC. AAaarh!"

    //this.set('route.path', '/start');
  },

  tostepone: function() {
    this.set('route.path', '/stepone');
  },

  checkallowance: function() {
    debugger;
    console.log('web3', this.web3);


    var self = this;

    this.$.helpers.getjson('./contracts/ARCToken.json', function(err, arctokenjson) {

      // this.contractjson = JSON.parse(e.target.import.body.innerText);
      //    self.web3.eth.getGasPrice(function(err, result){
      //   var gasPrice = result.toNumber(10);
      // console.log('gasprice: ', gasPrice);

      var MyContract = self.web3.eth.contract(arctokenjson.abi);
      var myContractInstance = MyContract.at(self.$.helpers.arcaddress);
      console.log('doing transfer of ', amount, ' to: ', to, 'from: ', window.account);
      myContractInstance.transfer.sendTransaction(to, amount, {
        from: self.$.helpers.fixaddress(window.account),
        gasPrice: gasPrice,
        gasLimit: 3000000,
        gas: 2000000
      }, function(err, result) {
        console.log(err, result);
        var coinbalance = myContractInstance.balanceOf(self.$.helpers.fixaddress(window.account));
        self.arcbalance = coinbalance;
        if (cb) {
          cb(err, result);
        }
      });

    });


  },

  startconversion: function() {
    var self = this;
    this.checkallowance();
    this.$.startbtn.hidden = true;
    this.$.processspinner.hidden = false;
    window.setTimeout(function(){
      this.$.s1.status = "working";
      window.setTimeout(function(){
        this.$.s1.status = "done";
        window.setTimeout(function(){
          this.$.s2.status = "working";
          window.setTimeout(function(){
            this.$.s2.status = "done";
            window.setTimeout(function(){
              this.$.s3.status = "working";
              window.setTimeout(function(){
                this.$.s3.status = "done";
                window.setTimeout(function(){
                  this.$.s4.status = "working";
                  window.setTimeout(function(){
                    this.$.s4.status = "done";
                    this.$.continuebtn.hidden = false;
                    this.$.processspinner.hidden = true;
                  }.bind(this), 2000);
                }.bind(this), 2000);
              }.bind(this), 2000);
            }.bind(this), 2000);
          }.bind(this), 2000);
        }.bind(this), 2000);
      }.bind(this), 2000);
    }.bind(this), 1000);


  },



    collapseMe: function(e)  {
      var item = e.target.parentNode.id;

      var itemp = e.target.id;
      var collapsid = itemp + 'collapser';
      var collapsdis = document.getElementById(collapsid);
      collapsdis.toggle();

      var showbool = itemp + 'show';

      if (showbool=='giveallowanceshow') {
        this.giveallowanceshow =! this.giveallowanceshow;
      }

      if (showbool=='converttokensshow') {
        this.converttokensshow =! this.converttokensshow;
      }


      // this.itemshow =! this.itemshow;
      console.log("*******",this.giveallowanceshow, "**************showbool",showbool );


      // var itemtotal = document.getElementById(item);
      // if (itemtotal){
      //   if (collapsdis.opened){
      //    itemtotal.classList.add("openedcoll");
      //   } else {
      //    itemtotal.classList.remove("openedcoll");
      //   }
      // }
    },


    startconvert: function () {
      this.convertingstarted = true;
      this.firststate = 'doing';
    },

    succestest: function () {
      this.firststate = 'succes';
      this.secondstate = 'doing';
    },

    errortest: function () {
      this.secondstate = 'error';
    },
    
    _is: function(a, b) {
      if (b === undefined) {
        b = true;
      }
      return a === b;
    },

});
</script>
</dom-module>
